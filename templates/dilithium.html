<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dilithium - PQC API</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="{{ url_for('static', filename='js/pqcapi.js') }}" defer></script>
</head>
<body>
  <header>
    Dilithium - PQC API
  </header>
  <nav>
    <a href ="{{ url_for('index')}}">Home</a>
    <a href ="{{ url_for('kyber_page')}}">Kyber</a>
    <a href ="{{ url_for('dilithium_page')}}">Dilithium</a>
  </nav>
  
  <div class="dilithium-container">
    <div class="dilithium-title">Dilithium ì„œëª…/ê²€ì¦</div>
    
    <!-- ë³´ì•ˆ ë ˆë²¨ ì„¤ì • (ìµœìƒë‹¨ì— í•œ ë²ˆë§Œ) -->
    <div class="dilithium-security">
      <label class="dilithium-label">ë³´ì•ˆë ˆë²¨ ì„¤ì •</label>
      <select class="dilithium-select" id="global-security-level">
        <option value="4">Dilithium2</option>
        <option value="5">Dilithium3</option>
        <option value="6">Dilithium5</option>
      </select>
      <p class="dilithium-warning">ì„ íƒí•œ ë³´ì•ˆë ˆë²¨ì€ ëª¨ë“  Dilithium ì—°ì‚°ì— ì ìš©ë©ë‹ˆë‹¤.</p>
    </div>
    
    <div class="dilithium-row">
      <!-- Keypair -->
      <div class="dilithium-col">
        <h3>Dilithium Keypair</h3>
        <button class="dilithium-btn" id="ml-dsa-generate-keypair-btn">ìƒì„±í•˜ê¸°</button>
        <button class="dilithium-btn" id="ml-dsa-reset-keypair-btn" style="background:#bdbdbd;">ì´ˆê¸°í™”</button>
        <label class="dilithium-label">ê³µê°œí‚¤ (PK)</label>
        <textarea class="dilithium-textarea" id="ml-dsa-public-key" rows="3" readonly></textarea>
        <button class="dilithium-copy-btn" data-target="ml-dsa-public-key">COPY PUBLIC KEY</button>
        <label class="dilithium-label">ë¹„ë°€í‚¤ (SK)</label>
        <textarea class="dilithium-textarea" id="ml-dsa-private-key" rows="3" readonly></textarea>
        <button class="dilithium-copy-btn" data-target="ml-dsa-private-key">COPY PRIVATE KEY</button>
      </div>
      
      <!-- Sign -->
      <div class="dilithium-col">
        <h3>Dilithium Sign</h3>
        <label class="dilithium-label">ë¹„ë°€í‚¤ (SK)</label>
        <input class="dilithium-input" id="ml-dsa-sign-sk" type="text" placeholder="ë¹„ë°€í‚¤ ì…ë ¥">
        
        <label class="dilithium-label">ë©”ì‹œì§€ (Message)</label>
        <input class="dilithium-input" id="ml-dsa-sign-msg" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥">
        
        <!-- íŒŒì¼ ì§ì ‘ ì„ íƒ ë²„íŠ¼ -->
        <input type="file" id="file-sign" class="dilithium-file-input">
        <label for="file-sign" class="dilithium-file-btn">
          <i>ğŸ“</i> íŒŒì¼ë¡œ ì„œëª…í•˜ê¸°
        </label>
        <div id="file-name-sign" class="dilithium-file-name"></div>
        
        <button class="dilithium-btn" id="ml-dsa-sign-btn">ì„œëª…í•˜ê¸°</button>
        <button class="dilithium-btn" id="reset-sign-btn" style="background:#bdbdbd;">ì´ˆê¸°í™”</button>
        <label class="dilithium-label">ì„œëª…ê°’ (Signature)</label>
        <textarea class="dilithium-textarea" rows="3" readonly></textarea>
        <button class="dilithium-copy-btn">COPY SIGNATURE</button>
      </div>
      
      <!-- Verify -->
      <div class="dilithium-col">
        <h3>Dilithium Verify</h3>
        <label class="dilithium-label">ê³µê°œí‚¤ (PK)</label>
        <input class="dilithium-input" id="ml-dsa-verify-pk" type="text" placeholder="ê³µê°œí‚¤ ì…ë ¥">
        <label class="dilithium-label">ì„œëª…ê°’ (Signature)</label>
        <input class="dilithium-input" id="ml-dsa-verify-sig" type="text" placeholder="ì„œëª…ê°’ ì…ë ¥">
        
        <label class="dilithium-label">ë©”ì‹œì§€ (Message)</label>
        <input class="dilithium-input" id="ml-dsa-verify-msg" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥">
        
        <!-- íŒŒì¼ ì§ì ‘ ì„ íƒ ë²„íŠ¼ -->
        <input type="file" id="file-verify" class="dilithium-file-input">
        <label for="file-verify" class="dilithium-file-btn">
          <i>ğŸ“</i> íŒŒì¼ë¡œ ê²€ì¦í•˜ê¸°
        </label>
        <div id="file-name-verify" class="dilithium-file-name"></div>
        
        <button class="dilithium-btn" id="ml-dsa-verify-btn">ê²€ì¦í•˜ê¸°</button>
        <button class="dilithium-btn" id="reset-verify-btn" style="background:#bdbdbd;">ì´ˆê¸°í™”</button>
        <div class="dilithium-result">ê²€ì¦ê²°ê³¼: <span id="verify-result">-</span></div>
      </div>
    </div>
  </div>
  <script>
    // ë©”ì‹œì§€ ì…ë ¥ì°½ê³¼ íŒŒì¼ ì„ íƒ ìš”ì†Œë¥¼ ìƒí˜¸ ë°°íƒ€ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì½”ë“œ
    document.addEventListener('DOMContentLoaded', () => {
      const messageInput = document.getElementById('ml-dsa-sign-msg');
      const fileInput = document.getElementById('file-sign');
      const fileNameDisplay = document.getElementById('file-name-sign');

      // ë©”ì‹œì§€ ì…ë ¥ ì‹œ íŒŒì¼ ì„ íƒ ë¹„í™œì„±í™”
      messageInput.addEventListener('input', () => {
        if (messageInput.value.trim()) {
          fileInput.disabled = true;
          // íŒŒì¼ ì„ íƒì´ ë˜ì–´ ìˆë‹¤ë©´ ì´ˆê¸°í™”
          fileInput.value = '';
          fileNameDisplay.textContent = '';
        } 
        else {
          fileInput.disabled = false;
        }
      });

      // íŒŒì¼ ì„ íƒ ì‹œ ë©”ì‹œì§€ ì…ë ¥ ë¹„í™œì„±í™”
      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];

        if (file) {
          messageInput.disabled = true;
          messageInput.value = '';
          fileNameDisplay.textContent = file.name;
        }
        else {
          messageInput.disabled = false;
          fileNameDisplay.textContent = '';
        }
      });

      // ê²€ì¦ ë¶€ë¶„ì—ë„ ë™ì¼í•œ ë¡œì§ ì ìš©
      const verifyMessageInput = document.getElementById('ml-dsa-verify-msg');
      const verifyFileInput = document.getElementById('file-verify');
      const verifyFileNameDisplay = document.getElementById('file-name-verify');
      
      // ë©”ì‹œì§€ ì…ë ¥ ì‹œ íŒŒì¼ ì„ íƒ ë¹„í™œì„±í™”
      verifyMessageInput.addEventListener('input', () => {
        if (verifyMessageInput.value.trim()) {
          verifyFileInput.disabled = true;
          // íŒŒì¼ ì„ íƒì´ ë˜ì–´ ìˆì—ˆë‹¤ë©´ ì´ˆê¸°í™”
          verifyFileInput.value = '';
          verifyFileNameDisplay.textContent = '';
        } else {
          verifyFileInput.disabled = false;
        }
      });
      
      // íŒŒì¼ ì„ íƒ ì‹œ ë©”ì‹œì§€ ì…ë ¥ ë¹„í™œì„±í™”
      verifyFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        
        if (file) {
          verifyMessageInput.disabled = true;
          verifyMessageInput.value = '';
          verifyFileNameDisplay.textContent = file.name;
        } else {
          verifyMessageInput.disabled = false;
          verifyFileNameDisplay.textContent = '';
        }
      });

      
      // ì´ˆê¸°í™” ë²„íŠ¼ ê¸°ëŠ¥ êµ¬í˜„
      const resetSignButton = document.getElementById('reset-sign-btn');
      if (resetSignButton) {
        resetSignButton.addEventListener('click', () => {
          messageInput.value = '';
          messageInput.disabled = false;
          fileInput.value = '';
          fileInput.disabled = false;
          fileNameDisplay.textContent = '';
          document.getElementById('ml-dsa-sign-sk').value = '';
          document.getElementById('ml-dsa-signature').value = '';
        });
      }
    
      const resetVerifyButton = document.getElementById('reset-verify-btn');
      if (resetVerifyButton) {
        resetVerifyButton.addEventListener('click', () => {
          verifyMessageInput.value = '';
          verifyMessageInput.disabled = false;
          verifyFileInput.value = '';
          verifyFileInput.disabled = false;
          verifyFileNameDisplay.textContent = '';
          document.getElementById('ml-dsa-verify-pk').value = '';
          document.getElementById('ml-dsa-verify-sig').value = '';
          document.getElementById('verify-result').textContent = '-';
          document.getElementById('verify-result').style.color = '';
        });
      }
    });


    // dilithium ë³´ì•ˆ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸° (ëª¨ë“  ì—°ì‚°ì„ ìœ„í•´ í•„ìš”í•¨)
    function getSecurityLevel() {
      return parseInt(document.getElementById('global-security-level').value);
    }

    // dilithium keypair ìƒì„± ê¸°ëŠ¥ ì²˜ë¦¬ ë²„íŠ¼ ì •ì˜
    document.getElementById('ml-dsa-generate-keypair-btn').addEventListener('click', async () => {
      try {
        const result = await pqcApi.generateDilithiumKeyPair(getSecurityLevel());
        document.getElementById('ml-dsa-public-key').value = result.publicKey;
        document.getElementById('ml-dsa-private-key').value = result.privateKey;
      }
      catch (error) {
        alert('í‚¤ìŒ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    });

    // dilithium í‚¤ ìŒ ì´ˆê¸°í™” ê¸°ëŠ¥ ì²˜ë¦¬ ë²„íŠ¼ ì •ì˜
    document.getElementById('ml-dsa-reset-keypair-btn').addEventListener('click', () => {
      document.getElementById('ml-dsa-public-key').value = '';
      document.getElementById('ml-dsa-private-key').value = '';
    });



    // dilithium ì„œëª… ê¸°ëŠ¥ ì²˜ë¦¬ ë²„íŠ¼ ì •ì˜
    // ì„œëª…í•˜ê¸° ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€í•´ì„œ ì›¹ <-> js <-> flask í†µì‹  ìœ ë„
    documnet.getElementById('ml-dsa-sign-button').addEventListener('click', async () => {
      const privateKey = document.getElementById('ml-dsa-sign-sk').value;
      const messageInput = document.getElementById('ml-dsa-sign-msg').value;
      const fileInput = document.getElementById('file-sign');

      if (!privateKey) {
        alert('ë¹„ë°€í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë°”ì´íŠ¸ ë°°ì—´ë¡œ ì €ì¥í•  ë³€ìˆ˜
        let message;
        // 1ì°¨ ifë¡œ ì´í›„ì—ëŠ” else ifë¡œ êµ¬ì„±í•  ì˜ˆì •
        // ë©”ì‹œì§€ ì…ë ¥ê³¼ íŒŒì¼ ì„ íƒ ì¤‘ ì–´ë–¤ ê²ƒì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if (!messageInput.disabled && messageInput.value.trim()) {
          // ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì§ì ‘ ì…ë ¥í•œ ê²½ìš°
          // ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¬¸ìì—´ì„ uint8array í˜•ì‹ì˜ ë°”ì´íŠ¸ ë°°ì—´ë¡œ ë³€í™˜í•œ ê²ƒì„.
          const encoder = new TextEncoder();
          message = encoder.encode(messageInput.value);
        }
        // íŒŒì¼ ì„ íƒ ì…ë ¥ì´ í™œì„±í™” ë˜ì–´ ìˆê³  ê°’ì´ ìˆëŠ” ê²½ìš°
        else if (!fileInput.disabled && fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const fileReader = new FileReader();

          // íŒŒì¼ ì½ê¸° Promise ìƒì„±
          // ê·¼ë° íŒŒì¼ ì½ê¸° í•  ë•Œ ì¼ì • ìš©ëŸ‰ ë„˜ì–´ê°€ë©´ ê±°ë¶€ ë–„ë¦¬ëŠ” ê²ƒ ë„£ì–´ì¤˜ì•¼ í• ë“¯ ì„œë²„í„°ì§ˆ ê²ƒ ê°™ìŒ.
          const fileLoadPromise = new Promise((resolve, reject) => {
            fileReader.onload = (e) => resolve(e.target.result);
            fileReader.onerror = (e) => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));

          });

          // íŒŒì¼ì„ ArrayBufferë¡œ ì½ê¸°
          fileReader.readAsArrayBuffer(file);

          // íŒŒì¼ ì½ê¸° ì™„ë£Œ ëŒ€ê¸°
          const fileData = await fileLoadPromise;
          // íŒŒì¼ ì½ì€ê±° Uint8 í˜•ì‹ì˜ ë°°ì—´ë¡œ messageì— ë„£ì–´ì¤Œ.
          message = new Uint8Array(fileData);
        }
        // ë©”ì‹œì§€ë„, íŒŒì¼ë„ ì—†ëŠ” ê²½ìš°
        else {
          alert('ë©”ì‹œì§€ ì…ë ¥ ë˜ëŠ” íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ë³´ì•ˆ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
        const securityLevel = getSecurityLevel();

        // ì„œëª… ìƒì„± API í˜¸ì¶œ
        const result = await pacApi.singDilithium(message, privateKey, securityLevel);

        // ì„œëª… ê²°ê³¼ í‘œì‹œ
        document.getElementById('ml-dsa-signature').value = result.signature;

      }
      catch (error) {
        alert('ì„œëª… ìƒì„± ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    });


  </script>
</body>
</html>